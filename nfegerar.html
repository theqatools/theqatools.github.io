<!DOCTYPE html>
<html lang="pt-br">
    <head>
        <title>The QA Tools - Demo site</title>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1"/>
        <link rel="stylesheet" href="css/normalize.css">
        <link rel="stylesheet" href="css/reset.css" />
        <link rel="stylesheet" href="css/base.css" />
        <link rel="stylesheet" href="css/header.css">
        <link rel="stylesheet" href="css/nfeGenerator.css">
        <link rel="stylesheet" href="css/footer.css">
    </head>
    <body onresize="onResize()">
        <header>
            <div class="flex-grid">
                <div class="menu-hamburguer">
                    <input id="menu-hamburguer" type="checkbox" onclick="showMenu()">
                    <label for="menu-hamburguer">
                        <div class="menu">
                            <span class="hamburguer"></span>
                        </div>
                    </label>
                </div>
                <div class="title grid-6">
                    <h1><a href="index.html">The QA Tools - Demo site</a></h1>
                </div>
                <nav class="grid-10" id="menuNav">
                    <div class="tool-options grid-3">
                        <h2>CNPJ</h2>
                        <ul>
                            <li><a href="cnpjgerar.html">Gerar</a></li>
                            <li><a href="cnpjvalidar.html">Validar</a></li>
                        </ul>
                    </div>
                    <div class="tool-options grid-3">
                        <h2>Chave NFe</h2>
                        <ul>
                            <li><a href="nfegerar.html">Gerar</a></li>
                            <li><a href="nfevalidar.html">Validar</a></li>
                        </ul>
                    </div>
                </nav>
            </div>
        </header>
        <main>
            <div class="nfe-area">
                <span id="invalid-cnpj-text" class="invalid-text">CNPJ inválido</span>
                <div class="flex-grid info">
                    <div class="grid-5 gerar-cnpj">
                        <div class="gerar-cnpj-input">
                            <input placeholder="CNPJ" type="text" id="cnpj" minlength="14" maxlength="14" required />
                        </div>
                        <button id="gerar-cnpj" class="rdn-gen-link">Gerar CNPJ</button>
                    </div>

                    <div class="grid-5 uf-select">
                        <label for="uf">
                            UF
                        </label>
                        <select id="uf" required>
                            <option value="11">Rondônia</option>
                            <option value="12">Acre</option>
                            <option value="13">Amazonas</option>
                            <option value="14">Roraima</option>
                            <option value="15">Pará</option>
                            <option value="16">Amapá</option>
                            <option value="17">Tocantins</option>
                            <option value="21">Maranhão</option>
                            <option value="22">Piauí</option>
                            <option value="23">Ceará</option>
                            <option value="24">Rio Grande do Norte</option>
                            <option value="25">Paraíba</option>
                            <option value="26">Pernambuco</option>
                            <option value="27">Alagoas</option>
                            <option value="28">Sergipe</option>
                            <option value="29">Bahia</option>
                            <option value="31">Minas Gerais</option>
                            <option value="32">Espírito Santo</option>
                            <option value="33">Rio de Janeiro</option>
                            <option value="35" selected>São Paulo</option>
                            <option value="41">Paraná</option>
                            <option value="42">Santa Catarina</option>
                            <option value="43">Rio Grande do Sul</option>
                            <option value="50">Mato Grosso do Sul</option>
                            <option value="51">Mato Grosso</option>
                            <option value="52">Goiás</option>
                            <option value="53">Distrito Federal</option>
                        </select>
                    </div>

                    <div class="grid-6 year-month-group">
                        <label>Mês/Ano emissão</label>
                        <select id="mes" required>
                            <option value="1">Janeiro</option>
                            <option value="2">Fevereiro</option>
                            <option value="3">Março</option>
                            <option value="4">Abril</option>
                            <option value="5">Maio</option>
                            <option value="6">Junho</option>
                            <option value="7">Julho</option>
                            <option value="8">Agosto</option>
                            <option value="9">Setembro</option>
                            <option value="10">Outubro</option>
                            <option value="11">Novembro</option>
                            <option value="12">Dezembro</option>
                        </select>
                        <input style="width: 4ch;" class="full-year-size" type="text" id="ano" minlength="4" maxlength="4" />
                    </div>
                </div>

                <div class="flex-grid">
                    <label for="modelo" class="grid-4">
                        Modelo
                        <input type="text" style="width: 2ch;" id="modelo" value="55" minlength="2" maxlength="2" required />
                    </label>

                    <label for="serie" class="grid-4">
                        Série
                        <input type="text" style="width: 3ch;" id="serie" value="001" minlength="3" maxlength="3" required />
                    </label>

                    <label for="numero" class="grid-4">
                        Número da nota
                        <input type="text" style="width: 9ch;" id="numero" minlength="9" maxlength="9" required />
                        <a href="#" class="rdn-gen-link" id="gerar-nota">Gerar Número</a>
                    </label>

                    <label for="codigoNumerico" class="grid-4">
                        Código numérico
                        <input type="text" style="width: 9ch;" id="codigoNumerico" minlength="8" maxlength="8" required />
                        <a href="#" class="rdn-gen-link" id="gerar-codigo">Gerar Código</a>
                    </label>
                </div>

                <div class="flex-grid">
                    <label for="tipoEmissao" class="grid-2">
                        Forma de emissão
                        <select id="tipoEmissao">
                            <option value="1" selected>Normal</option>
                            <option value="2">Contingência FS</option>
                            <option value="3">Contingência SCAN</option>
                            <option value="4">Contingência DPEC</option>
                            <option value="5">Contingência FS-DA</option>
                        </select>
                    </label>

                    <div class="grid-12">
                        <label for="chave-nfe">
                            Chave NF-e
                            <input type="text" placeholder="Chave NF-e" class="copyable-input" id="chave-nfe" readonly />
                            <span id="valid-text-copy-nfe" style="text-align: right;" class="valid-text">Chave copiada para área de transferência!</span>
                        </label>
                    </div>
                </div>
                <div class="grid-16">
                    <button id="btn-gen-nfe">Gerar Chave de Acesso</button>
                </div>
            </div>
            <span id="valid-text" class="valid-text">CNPJ válido</span>
            <span id="invalid-text" class="invalid-text">CNPJ inválido</span>
        </main>
        <footer>
            <p>&copy; The QA Tools - <a href="desenvolvedores.html">Desenvolvedores</a></p>
        </footer>
        <script src="js/script.js"></script>
        <script type="module">
            import {generateKey, validateKey, NFe} from "./js/nfe_utils.js";
            import {nextI32} from "./js/rnd_utils.js";
            import {cnpjIsValid, generateCnpj} from "./js/cnpj_utils.js";

            function getNFeKeyInContext() {
                let urlParams = new URLSearchParams(window.location.search);
                return urlParams.get("nfe-vizualize");
            }

            function valKey(nfeKey) {
                if (nfeKey) return validateKey(nfeKey);
                return null;
            }

            function generateNumericCode() {
                getEl("codigoNumerico").value = nextI32(1, 99999999);
            }

            function generateNFNumber() {
                getEl("numero").value = nextI32(1, 999999999);
            }

            function genCnpj() {
                getEl("cnpj").value = generateCnpj();
                getEl("cnpj").focus();
                getEl("cnpj").blur();
            }

            function valCnpj(e) {
                let cnpj = e.target.value;
                if (cnpj.length !== 14 || !cnpjIsValid(cnpj)) {
                    setDisplay("invalid-cnpj-text", "block");
                } else {
                    setDisplay("invalid-cnpj-text", "none");
                }
            }

            function getYearMonth() {
                const month = getEl("mes").value;
                const year = getEl("ano").value;

                return year.substring(2, 4) + month.padStart(2, "0");
            }

            function genKey() {
                const nfe = NFe.new();
                nfe.issuerCnpj = getEl("cnpj").value;
                nfe.yearMonth = getYearMonth();
                nfe.uf = getEl("uf").value;
                nfe.model = getEl("modelo").value;
                nfe.serie = getEl("serie").value;
                nfe.nfeNumber = getEl("numero").value;
                nfe.code = getEl("codigoNumerico").value;
                nfe.issueMode = getEl("tipoEmissao").value;
                getEl("chave-nfe").value = generateKey(nfe);
            }

            function copyNFe() {
                copy("chave-nfe");
                setDisplay("valid-text-copy-nfe", "block")
            }

            addHandler("gerar-codigo", "click", generateNumericCode);
            addHandler("gerar-nota", "click", generateNFNumber);
            addHandler("gerar-cnpj", "click", genCnpj);
            addHandler("cnpj", "paste", valCnpj);
            addHandler("cnpj", "blur", valCnpj);
            addHandler("cnpj", "keyup", valCnpj);
            addHandler("cnpj", "input", valCnpj);
            addHandler("btn-gen-nfe", "click", genKey);
            addHandler("chave-nfe", "mouseup", copyNFe);
            addHandler("chave-nfe", "blur", e => setDisplay("valid-text-copy-nfe", "none"));

            setTimeout(function() {
                let nfeKey = getNFeKeyInContext();
                let validationResult = valKey(nfeKey);
                if (validationResult && validationResult.isValid) {
                    setDisplay("gerar-cnpj", "none");
                    setDisplay("gerar-codigo", "none");
                    setDisplay("gerar-nota", "none");
                    setDisplay("btn-gen-nfe", "none");
                    getEl("cnpj").value = validationResult.nfe.issuerCnpj;
                    getEl("uf").value = validationResult.nfe.uf;
                    getEl("modelo").value = validationResult.nfe.model;
                    getEl("serie").value = validationResult.nfe.serie;
                    getEl("numero").value = validationResult.nfe.nfeNumber;
                    getEl("codigoNumerico").value = validationResult.nfe.code;
                    getEl("tipoEmissao").value = validationResult.nfe.issueMode;
                    getEl("chave-nfe").value = nfeKey;
                    let yearMonth = validationResult.nfe.yearMonth;
                    getEl("mes").value = parseInt(yearMonth.slice(2, 4), 10);
                    getEl("ano").value = yearMonth.slice(0, 2);
                } else {
                    const today = new Date();
                    document.getElementById("mes").value = today.getMonth() + 1; //WTF, JS!?
                    document.getElementById("ano").value = today.getFullYear();
                }
            }, 1000);
        </script>
    </body>
</html>
